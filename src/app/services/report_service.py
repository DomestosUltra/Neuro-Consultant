import logging
from typing import Dict, Any, Optional

# Настройка логирования
logger = logging.getLogger(__name__)


class ReportService:
    """Сервис для работы с генетическими отчетами пользователей"""

    async def get_user_report(self, user_id: int) -> Dict[str, Any]:
        """
        Получает отчет пользователя из БД

        Args:
            user_id: ID пользователя

        Returns:
            Словарь с данными отчета
        """
        # В реальном приложении здесь будет запрос к БД (MongoDB)
        # Для демонстрации возвращаем тестовые данные
        return self._get_mock_report(user_id)

    async def get_section_data(
        self, user_id: int, section: str
    ) -> Optional[Dict[str, Any]]:
        """
        Получает данные конкретного раздела отчета

        Args:
            user_id: ID пользователя
            section: Имя раздела (detox, behavior, carb, sport, lipid)

        Returns:
            Словарь с данными раздела или None, если раздел не найден
        """
        report = await self.get_user_report(user_id)
        return report.get("sections", {}).get(section)

    def _get_mock_report(self, user_id: int) -> Dict[str, Any]:
        """
        Создает мок-отчет для тестирования

        Args:
            user_id: ID пользователя

        Returns:
            Словарь с тестовыми данными отчета
        """
        return {
            "user_id": user_id,
            "codelab": f"TEST{user_id}2023",
            "creation_date": "2023-09-01",
            "summary": "Ваш генетический отчет показывает средний риск проблем с метаболизмом, хорошие показатели детоксикации и предрасположенность к силовым видам спорта.",
            "sections": {
                "detox": {
                    "summary": "Вы имеете хорошие показатели работы систем детоксикации.",
                    "detail": "Ваши гены, отвечающие за детоксикацию, показывают нормальную или повышенную активность ферментов фазы I и II. Это означает эффективную нейтрализацию и выведение токсинов из организма.",
                    "genes": [
                        {
                            "name": "CYP1A2",
                            "variant": "AA",
                            "effect": "Быстрый метаболизм кофеина",
                        },
                        {
                            "name": "GSTP1",
                            "variant": "AG",
                            "effect": "Средняя активность глутатион-S-трансферазы",
                        },
                    ],
                    "recommendations": [
                        "Регулярное употребление крестоцветных овощей (брокколи, капуста)",
                        "Достаточное потребление воды - не менее 2 литров в день",
                    ],
                },
                "behavior": {
                    "summary": "У вас выявлена генетическая предрасположенность к повышенному аппетиту.",
                    "detail": "Анализ генов, связанных с пищевым поведением, показывает вариации, которые могут приводить к более интенсивному чувству голода и замедленному наступлению насыщения.",
                    "genes": [
                        {
                            "name": "FTO",
                            "variant": "AT",
                            "effect": "Повышенный риск избыточного веса",
                        },
                        {
                            "name": "MC4R",
                            "variant": "CT",
                            "effect": "Склонность к перееданию",
                        },
                    ],
                    "recommendations": [
                        "Регулярный режим питания, прием пищи в одно и то же время",
                        "Включение в рацион продуктов, богатых клетчаткой",
                    ],
                },
                "carb": {
                    "summary": "Вы имеете нормальный метаболизм углеводов с небольшой склонностью к инсулинорезистентности.",
                    "detail": "Генетический анализ указывает на нормальную способность к усвоению углеводов, но имеется небольшая предрасположенность к развитию инсулинорезистентности при избыточном потреблении простых углеводов.",
                    "genes": [
                        {
                            "name": "TCF7L2",
                            "variant": "CT",
                            "effect": "Умеренно повышенный риск диабета 2 типа",
                        },
                        {
                            "name": "PPARG",
                            "variant": "CC",
                            "effect": "Нормальная чувствительность к инсулину",
                        },
                    ],
                    "recommendations": [
                        "Ограничение потребления простых углеводов",
                        "Предпочтение сложным углеводам с низким гликемическим индексом",
                    ],
                },
                "sport": {
                    "summary": "Ваш генетический профиль указывает на предрасположенность к силовым видам нагрузки.",
                    "detail": "Анализ показывает преобладание быстрых мышечных волокон и эффективную работу сердечно-сосудистой системы при интенсивных кратковременных нагрузках.",
                    "genes": [
                        {
                            "name": "ACTN3",
                            "variant": "RR",
                            "effect": "Преобладание быстрых мышечных волокон",
                        },
                        {
                            "name": "ACE",
                            "variant": "DD",
                            "effect": "Предрасположенность к силовым тренировкам",
                        },
                    ],
                    "recommendations": [
                        "Эффективны силовые тренировки с небольшим количеством повторений",
                        "Короткие интенсивные кардиотренировки (HIIT)",
                    ],
                },
                "lipid": {
                    "summary": "У вас выявлен умеренно повышенный риск нарушений липидного обмена.",
                    "detail": "Генетический анализ показывает склонность к повышенному уровню ЛПНП (плохой холестерин) и небольшому снижению ЛПВП (хороший холестерин).",
                    "genes": [
                        {
                            "name": "APOE",
                            "variant": "E3/E4",
                            "effect": "Умеренно повышенный риск атеросклероза",
                        },
                        {
                            "name": "CETP",
                            "variant": "GA",
                            "effect": "Сниженный уровень ЛПВП",
                        },
                    ],
                    "recommendations": [
                        "Ограничение потребления насыщенных жиров",
                        "Увеличение доли омега-3 жирных кислот в рационе",
                    ],
                },
            },
        }
